<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ìŠ¤ë§ˆíŠ¸ ê±´ì¶•ë¬¼ëŒ€ì¥ - ì´ê´„í‘œì œë¶€(ê°‘) ê¸°ì¤€</title>
  <style>
    :root{
      --line:#000; --thin:1px; --pad:6px; --font:12px;
      --blue:#1a73e8; --bg:#f4f7f9;
    }
    body{ font-family:'Malgun Gothic',sans-serif; background:var(--bg); margin:0; padding:20px; }
    .wrap{ max-width:1100px; margin:0 auto; background:#fff; border-radius:12px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.08); }
    h1{ margin:0 0 12px; text-align:center; color:var(--blue); font-size:22px; }

    /* UI */
    .search-box{ text-align:center; padding:14px; border:2px solid #e8f0fe; border-radius:10px; margin-bottom:14px; }
    .btn{ background:var(--blue); color:#fff; border:none; padding:12px 30px; border-radius:8px; cursor:pointer; font-size:15px; font-weight:700; }
    .btn:active{ background:#1557b0; transform:scale(.98); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; transform:none; }
    #addr-display{ margin-top:10px; font-weight:700; color:var(--blue); }
    #search-layer{ display:none; border:2px solid #333; width:100%; height:460px; margin:10px 0 14px; position:relative; background:#fff; z-index:100; border-radius:8px; overflow:hidden; }
    .close-btn{ position:absolute; right:10px; top:10px; background:#333; color:#fff; border:none; padding:8px 12px; cursor:pointer; border-radius:6px; z-index:101; }
    #log-window{ background:#1e1e1e; color:#00ff00; padding:12px; border-radius:8px; font-family:Consolas, monospace; font-size:11px; height:170px; overflow-y:auto; margin-top:14px; }
    .log-entry{ margin-bottom:4px; border-bottom:1px solid #333; padding-bottom:4px; }
    .warn{ background:#fff7e6; color:#8a5a00; border:1px solid #ffe1a6; padding:10px; border-radius:10px; margin:12px 0; }
    .err{ background:#ffecec; color:#9c1a1a; border:1px solid #ffbcbc; padding:10px; border-radius:10px; margin:12px 0; }

    .form-actions{ display:flex; justify-content:flex-end; gap:8px; margin:10px 0; }
    .print-btn{ background:#34a853; }
    .ghost{ background:#6c757d; }

    /* A4 ì„œì‹(ê°€ë¡œ) */
    .form-a4{
      width: 297mm; min-height: 210mm; margin: 0 auto;
      background:#fff; border: var(--thin) solid var(--line);
      padding: 6mm; box-sizing:border-box; overflow:hidden;
    }
    .form-title{ text-align:center; font-weight:800; font-size:16px; margin:0 0 6px; }
    .top-meta{ display:flex; justify-content:space-between; align-items:flex-start; gap:8px; margin:2px 0 6px; font-size:11px; }
    .small{ font-size:11px; }
    .muted{ color:#666; }

    table.form{
      width:100%; border-collapse:collapse; table-layout:fixed;
      font-size:var(--font);
    }
    table.form td, table.form th{
      border: var(--thin) solid var(--line);
      padding: var(--pad);
      vertical-align:middle;
      word-break:break-word;
    }
    .lbl{ font-weight:700; background:#fff; }
    .center{ text-align:center; }
    .right{ text-align:right; }

    .section-head{
      margin:10px 0 4px;
      font-weight:800; font-size:13px;
      display:flex; align-items:center; justify-content:space-between; gap:8px;
    }

    /* filter ë²„íŠ¼ */
    .filter-box{ display:flex; gap:6px; flex-wrap:wrap; }
    .fbtn{
      background:#fff; border:1px solid #bbb; padding:4px 10px; border-radius:8px;
      cursor:pointer; font-size:12px; font-weight:700; color:#333;
    }
    .fbtn.active{
      border-color: var(--blue); color: var(--blue);
      box-shadow: 0 0 0 2px rgba(26,115,232,.15) inset;
    }

    @page { size: A4 landscape; margin: 8mm; }
    @media print{
      body{ background:#fff; padding:0; }
      .wrap{ box-shadow:none; border-radius:0; padding:0; }
      .search-box, #search-layer, #log-window, .form-actions, .btn, .close-btn, h1 { display:none !important; }
      .filter-box{ display:none !important; }
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ¢ ìŠ¤ë§ˆíŠ¸ ê±´ì¶•ë¬¼ëŒ€ì¥ ì¡°íšŒ (ì´ê´„í‘œì œë¶€(ê°‘) ê¸°ì¤€)</h1>

  <div class="search-box">
    <button class="btn" onclick="startSearch()">ğŸ” ì£¼ì†Œ ê²€ìƒ‰ ì‹œì‘</button>
    <div id="addr-display">ì£¼ì†Œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.</div>
    <div class="small muted" style="margin-top:8px;">
      â€» ìƒë‹¨ ìš”ì•½ê°’ì€ â€œì´ê´„í‘œì œë¶€(ê°‘)â€ ê¸°ì¤€ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤. (getBrRecapTitleInfo ìš°ì„ )
    </div>
  </div>

  <div id="search-layer"><button class="close-btn" onclick="closeSearch()">ë‹«ê¸° X</button></div>

  <div class="form-actions">
    <button class="btn ghost" onclick="collapseAll()">ì ‘ê¸°/í¼ì¹˜ê¸°</button>
    <button class="btn print-btn" onclick="window.print()">PDF ì €ì¥(ì¸ì‡„)</button>
  </div>

  <div id="result-container"></div>

  <div id="log-window"><div class="log-entry">ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ. [recap-first]</div></div>
</div>

<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
  const KEY  = 'qxYCqkstCZ8XGIddZD07gVxLSNV8Ivpcp4QNatFfp4nS3lmhVB4kg1F4%2BPoFnHGjlKViFlvHtKGzNpcR4WIHbw%3D%3D';
  const BASE = 'https://apis.data.go.kr/1613000/BldRgstHubService';

  let saved = null;
  let collapsed = false;

  let cachedData = null;
  let pubuseFilter = 'ALL'; // ALL | PRIVATE | PUBLIC

  function addLog(msg, color='#00ff00'){
    const entry=document.createElement('div');
    entry.className='log-entry';
    entry.style.color=color;
    entry.innerText=`[${new Date().toLocaleTimeString()}] ${msg}`;
    document.getElementById('log-window').prepend(entry);
  }
  function closeSearch(){ document.getElementById('search-layer').style.display='none'; }

  function escapeHtml(str){
    return String(str ?? '')
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function parseJibun(jibunAddress){
    const s=(jibunAddress||'').trim();
    if(!s) return {ok:false};

    let m=s.match(/ì‚°\s*([0-9]{1,4})(?:-([0-9]{1,4}))?\s*$/);
    if(m){
      return {
        ok:true, platGbCd:'1',
        bun:String(parseInt(m[1],10)).padStart(4,'0'),
        ji:String(parseInt(m[2]||'0',10)).padStart(4,'0')
      };
    }
    m=s.match(/([0-9]{1,4})(?:-([0-9]{1,4}))?\s*$/);
    if(m){
      return {
        ok:true, platGbCd:'0',
        bun:String(parseInt(m[1],10)).padStart(4,'0'),
        ji:String(parseInt(m[2]||'0',10)).padStart(4,'0')
      };
    }
    return {ok:false};
  }

  function renderWarn(msg){
    document.getElementById('result-container').innerHTML = `<div class="warn">âš ï¸ ${escapeHtml(msg)}</div>`;
  }
  function renderError(msg){
    document.getElementById('result-container').innerHTML = `<div class="err">âŒ ${escapeHtml(msg)}</div>`;
  }

  async function fetchJson(url){
    const res = await fetch(url, {method:'GET'});
    const text = await res.text();
    try{ return JSON.parse(text); }
    catch(e){
      throw new Error("ì‘ë‹µì´ JSONì´ ì•„ë‹™ë‹ˆë‹¤. (CORS/ì„œë¹„ìŠ¤í‚¤/ì„œë²„ ì˜¤ë¥˜ ê°€ëŠ¥)\n" + text.slice(0,300));
    }
  }
  function normItems(json){
    const item = json?.response?.body?.items?.item;
    if(!item) return [];
    return Array.isArray(item) ? item : [item];
  }
  function pick(v, suffix=''){
    if(v === null || v === undefined || v === '') return '-';
    return String(v) + suffix;
  }
  function sumNums(arr, key){
    let s=0;
    for(const o of arr){
      const n = Number(o?.[key]);
      if(Number.isFinite(n)) s += n;
    }
    return s;
  }
  function collapseAll(){
    collapsed = !collapsed;
    document.querySelectorAll('[data-collapsible="1"]').forEach(el=>{
      el.style.display = collapsed ? 'none' : '';
    });
  }

  // ------- ì •ë ¬/íŒŒì‹± -------
  function floorSortKey(obj){
    const gb = String(obj?.flrGbCdNm || obj?.flrGbNm || obj?.flrGbCd || '').trim();
    const noRaw = (obj?.flrNoNm ?? obj?.flrNo ?? '').toString().trim();

    const noNum = Number(noRaw);
    if(Number.isFinite(noNum) && noRaw !== ''){
      if((gb.includes('ì§€í•˜') || gb.toLowerCase().includes('ug')) && noNum > 0) return -noNum;
      return noNum;
    }
    const m = noRaw.match(/-?\d+/);
    const n = m ? Number(m[0]) : 0;
    if(gb.includes('ì§€í•˜')) return -Math.abs(n || 0);
    return Math.abs(n || 0);
  }
  function floorLabel(key){
    if(key < 0) return `ì§€í•˜ ${Math.abs(key)}ì¸µ`;
    if(key === 0) return `0ì¸µ`;
    return key === 1 ? `ì§€ìƒ 1ì¸µ` : `${key}ì¸µ`;
  }
  function pubuseKind(row){
    const nm = String(row?.exposPubuseGbCdNm || row?.exposPubuseGbNm || '').trim();
    const cd = String(row?.exposPubuseGbCd || '').trim();
    const hay = (nm + ' ' + cd).toLowerCase();
    if(hay.includes('ì „ìœ ') || hay.includes('private')) return 'PRIVATE';
    if(hay.includes('ê³µìš©') || hay.includes('public')) return 'PUBLIC';
    return 'UNKNOWN';
  }
  function parseHo(hoStr){
    const s = String(hoStr ?? '').trim();
    const digits = s.match(/\d+/g);
    if(!digits) return { ok:false };
    const num = Number(digits.join(''));
    if(!Number.isFinite(num)) return { ok:false };
    const floor = Math.floor(num / 100);
    const unit = num % 100;
    return { ok:true, num, floor, unit };
  }
  function parseDateLoose(s){
    const str = String(s ?? '').trim();
    if(!str) return null;
    if(/^\d{8}$/.test(str)){
      const y=str.slice(0,4), m=str.slice(4,6), d=str.slice(6,8);
      const dt = new Date(`${y}-${m}-${d}T00:00:00`);
      return isNaN(dt.getTime()) ? null : dt;
    }
    const t = str.replaceAll('.', '-');
    const dt = new Date(`${t}T00:00:00`);
    return isNaN(dt.getTime()) ? null : dt;
  }
  function formatNumberComma(v){
    const n = Number(String(v).replaceAll(',','').trim());
    if(!Number.isFinite(n)) return '-';
    return new Intl.NumberFormat('ko-KR').format(n);
  }
  function pickAreaField(row){
    const candidates = [
      'area','prvuseArea','prvuseAr','prvArea','privateArea',
      'spc','spcArea','supplyArea','suplyArea','supplyAr'
    ];
    for(const k of candidates){
      if(row && row[k] !== undefined && row[k] !== null && row[k] !== ''){
        return String(row[k]);
      }
    }
    return '-';
  }

  // ------- ì£¼ì†Œ ê²€ìƒ‰ -------
  function startSearch(){
    addLog("ì£¼ì†Œê²€ìƒ‰ ë²„íŠ¼ í´ë¦­.");
    if(typeof daum==='undefined' || !daum.Postcode){
      addLog("ì—ëŸ¬: daum.Postcode ë¡œë“œ ì‹¤íŒ¨.", "#ea4335");
      alert("ì£¼ì†Œ ì„œë¹„ìŠ¤ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
      return;
    }

    const layer=document.getElementById('search-layer');
    layer.style.display='block';

    new daum.Postcode({
      oncomplete: function(data){
        const jibun = data.jibunAddress || data.autoJibunAddress || "";
        const addressToShow = data.address || jibun || "(ì£¼ì†Œ ì—†ìŒ)";
        document.getElementById('addr-display').innerText = "ğŸ“ " + addressToShow;

        const bcode=(data.bcode||'').trim();
        if(bcode.length < 10){
          addLog(`ì—ëŸ¬: bcode ë¹„ì •ìƒ. bcode="${bcode}"`, "#ea4335");
          renderError("ë²•ì •ë™ì½”ë“œ(bcode)ê°€ ë¹„ì •ìƒì´ë¼ ì¡°íšŒ íŒŒë¼ë¯¸í„°ë¥¼ ë§Œë“¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          closeSearch();
          return;
        }
        const sigunguCd=bcode.substring(0,5);
        const bjdongCd=bcode.substring(5,10);

        const parsed=parseJibun(jibun);
        if(!parsed.ok){
          addLog(`ê²½ê³ : ì§€ë²ˆ íŒŒì‹± ì‹¤íŒ¨. jibun="${jibun}"`, "#ffcc00");
          renderWarn("ì§€ë²ˆì£¼ì†Œ(ì˜ˆ: 'OOë™ 123-45')ë¥¼ íŒŒì‹±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì§€ë²ˆì£¼ì†Œê°€ í¬í•¨ë˜ë„ë¡ ì£¼ì†Œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.");
          closeSearch();
          return;
        }

        saved={ daum:data, sigunguCd, bjdongCd, platGbCd:parsed.platGbCd, bun:parsed.bun, ji:parsed.ji, jibunAddress:jibun };
        addLog(`íŒŒë¼ë¯¸í„° OK: sigunguCd=${sigunguCd}, bjdongCd=${bjdongCd}, platGbCd=${saved.platGbCd}, bun=${saved.bun}, ji=${saved.ji}`);

        pubuseFilter = 'ALL';
        cachedData = null;
        fetchAll();
        closeSearch();
      },
      width:'100%',
      height:'100%'
    }).embed(layer);
  }

  // ------- ì „ì²´ ì¡°íšŒ -------
  async function fetchAll(){
    if(!saved) return;
    const rc = document.getElementById('result-container');
    rc.innerHTML = "<p style='text-align:center;'>â³ ì „ì²´ API ì¡°íšŒ ì¤‘...</p>";

    const baseParams =
      `serviceKey=${KEY}` +
      `&sigunguCd=${saved.sigunguCd}` +
      `&bjdongCd=${saved.bjdongCd}` +
      `&platGbCd=${saved.platGbCd}` +
      `&bun=${saved.bun}` +
      `&ji=${saved.ji}` +
      `&_type=json`;

    try{
      addLog("10ê°œ API ë³‘ë ¬ ì¡°íšŒ ì‹œì‘...");

      const urls = {
        basis: `${BASE}/getBrBasisOulnInfo?${baseParams}&numOfRows=1000&pageNo=1`,
        recap: `${BASE}/getBrRecapTitleInfo?${baseParams}&numOfRows=1000&pageNo=1`,
        title: `${BASE}/getBrTitleInfo?${baseParams}&numOfRows=1000&pageNo=1`,
        flr:   `${BASE}/getBrFlrOulnInfo?${baseParams}&numOfRows=1000&pageNo=1`,
        atch:  `${BASE}/getBrAtchJibunInfo?${baseParams}&numOfRows=1000&pageNo=1`,
        pubuse:`${BASE}/getBrExposPubuseAreaInfo?${baseParams}&numOfRows=1000&pageNo=1`,
        wclf:  `${BASE}/getBrWclfInfo?${baseParams}&numOfRows=1000&pageNo=1`,
        hsprc: `${BASE}/getBrHsprcInfo?${baseParams}&numOfRows=1000&pageNo=1`,
        expos: `${BASE}/getBrExposInfo?${baseParams}&numOfRows=1000&pageNo=1`,
        jijigu:`${BASE}/getBrJijiguInfo?${baseParams}&numOfRows=1000&pageNo=1`,
      };

      const [
        basisJ, recapJ, titleJ, flrJ, atchJ, pubuseJ, wclfJ, hsprcJ, exposJ, jijiguJ
      ] = await Promise.all([
        fetchJson(urls.basis),
        fetchJson(urls.recap),
        fetchJson(urls.title),
        fetchJson(urls.flr),
        fetchJson(urls.atch),
        fetchJson(urls.pubuse),
        fetchJson(urls.wclf),
        fetchJson(urls.hsprc),
        fetchJson(urls.expos),
        fetchJson(urls.jijigu),
      ]);

      const data = {
        basis: normItems(basisJ),
        recap: normItems(recapJ),
        title: normItems(titleJ),
        flr:   normItems(flrJ),
        atch:  normItems(atchJ),
        pubuse:normItems(pubuseJ),
        wclf:  normItems(wclfJ),
        hsprc: normItems(hsprcJ),
        expos: normItems(exposJ),
        jijigu:normItems(jijiguJ),
      };

      // ì´ê´„í‘œì œë¶€(ê°‘)ê³¼ â€œê°™ì€ ê°’â€ì„ ëª©í‘œë¡œ í•˜ë¯€ë¡œ recapì´ ì—†ìœ¼ë©´ ê²½ê³ 
      if(data.recap.length === 0){
        addLog("ì´ê´„í‘œì œë¶€(getBrRecapTitleInfo) ê²°ê³¼ ì—†ìŒ.", "#ffcc00");
        renderWarn("ì´ê´„í‘œì œë¶€(ê°‘) ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. (ì´ ì£¼ì†ŒëŠ” ì´ê´„í‘œì œë¶€ê°€ ì—†ì„ ìˆ˜ ìˆìŒ) ê·¸ë˜ë„ í‘œì œë¶€ ë“±ì€ í‘œì‹œí•©ë‹ˆë‹¤.");
      }

      // ì •ë ¬
      data.flr.sort((a,b)=> floorSortKey(a) - floorSortKey(b));

      data.pubuse.sort((a,b)=>{
        const ka = floorSortKey(a);
        const kb = floorSortKey(b);
        if(ka !== kb) return ka - kb;
        return String(a?.exposPubuseGbCdNm||'').localeCompare(String(b?.exposPubuseGbCdNm||''), 'ko');
      });

      data.expos.sort((a,b)=>{
        const pa = parseHo(a?.hoNm || a?.hoNo || a?.unitNm || '');
        const pb = parseHo(b?.hoNm || b?.hoNo || b?.unitNm || '');
        if(pa.ok && pb.ok){
          if(pa.floor !== pb.floor) return pa.floor - pb.floor;
          if(pa.num !== pb.num) return pa.num - pb.num;
          return String(a?.dongNm||'').localeCompare(String(b?.dongNm||''), 'ko');
        }
        if(pa.ok && !pb.ok) return -1;
        if(!pa.ok && pb.ok) return 1;
        return String(a?.hoNm||a?.hoNo||'').localeCompare(String(b?.hoNm||b?.hoNo||''), 'ko');
      });

      data.hsprc.sort((a,b)=>{
        const da = parseDateLoose(a?.stdDay || a?.baseDay || a?.applcDay);
        const db = parseDateLoose(b?.stdDay || b?.baseDay || b?.applcDay);
        if(da && db) return da.getTime() - db.getTime();
        if(da && !db) return -1;
        if(!da && db) return 1;
        return String(a?.stdDay||'').localeCompare(String(b?.stdDay||''), 'ko');
      });

      // â€œê±´ì¶•ë¬¼ í˜„í™©(ì„)â€ì„ ê³µì‹ì²˜ëŸ¼ ë³´ì´ê²Œ: í‘œì œë¶€ item ì „ì²´ë¥¼ bldNm(ì£¼1/ë¶€1 ë“±) ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
      data.title.sort((a,b)=>{
        const an = String(a?.bldNm || a?.dongNm || '').trim();
        const bn = String(b?.bldNm || b?.dongNm || '').trim();
        // ì£¼/ë¶€ ìˆœì„œ: "ì£¼" ë¨¼ì €
        const aIsBu = an.startsWith('ë¶€');
        const bIsBu = bn.startsWith('ë¶€');
        if(aIsBu !== bIsBu) return aIsBu ? 1 : -1;
        // ìˆ«ì ì •ë ¬: ì£¼1, ì£¼2...
        const am = an.match(/\d+/); const bm = bn.match(/\d+/);
        const ai = am ? Number(am[0]) : 9999;
        const bi = bm ? Number(bm[0]) : 9999;
        if(ai !== bi) return ai - bi;
        return an.localeCompare(bn,'ko');
      });

      cachedData = data;

      addLog(`ì¡°íšŒ ì™„ë£Œ: recap=${data.recap.length}, title=${data.title.length}, flr=${data.flr.length}, pubuse=${data.pubuse.length}, expos=${data.expos.length}, hsprc=${data.hsprc.length}`);
      renderAll();

    }catch(e){
      addLog(`ì—ëŸ¬: ${e.message}`, "#ea4335");
      renderError(e.message);
    }
  }

  // í•„í„° ë³€ê²½ í›„ ì¬ë Œë”
  function setPubuseFilter(kind){
    pubuseFilter = kind;
    renderAll();
    document.querySelectorAll('[data-pubuse-filter]').forEach(b=>{
      b.classList.toggle('active', b.getAttribute('data-pubuse-filter') === kind);
    });
  }

  // ------- ë Œë”ë§(í•µì‹¬: recap ìš°ì„ ) -------
  function renderAll(){
    const data = cachedData;
    if(!data){ renderWarn("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }

    // âœ… í•µì‹¬: ìƒë‹¨ ìš”ì•½ì€ â€œì´ê´„í‘œì œë¶€(ê°‘)â€ ê¸°ì¤€(= recap)ìœ¼ë¡œ ê³ ì •
    const recap = data.recap[0] || {};
    // fallbackì€ ì¡´ì¬ë§Œ í•˜ë„ë¡
    const titleFallback = data.title[0] || {};
    const basisFallback = data.basis[0] || {};

    const bldName = (recap?.bldNm || recap?.dongNm || titleFallback?.bldNm || basisFallback?.bldNm || '-');
    const platPlc = (recap?.platPlc || titleFallback?.platPlc || basisFallback?.platPlc || saved?.jibunAddress || '-');

    const platArea = pick(recap?.platArea ?? titleFallback?.platArea ?? basisFallback?.platArea, 'ã¡');
    const totArea  = pick(recap?.totArea  ?? titleFallback?.totArea  ?? basisFallback?.totArea,  'ã¡');
    const archArea = pick(recap?.archArea ?? titleFallback?.archArea ?? basisFallback?.archArea, 'ã¡');
    const bcRat    = pick(recap?.bcRat    ?? titleFallback?.bcRat    ?? basisFallback?.bcRat,    '%');
    const vlRat    = pick(recap?.vlRat    ?? titleFallback?.vlRat    ?? basisFallback?.vlRat,    '%');

    const vlRatEstmTotArea = pick(recap?.vlRatEstmTotArea ?? titleFallback?.vlRatEstmTotArea ?? '-', 'ã¡'); // ì—†ìœ¼ë©´ -
    const useApr   = pick(recap?.useAprDay ?? titleFallback?.useAprDay ?? basisFallback?.useAprDay);
    const mainPurp = pick(recap?.mainPurpsCdNm ?? titleFallback?.mainPurpsCdNm ?? basisFallback?.mainPurpsCdNm);
    const zone     = pick(recap?.jijiguNm ?? recap?.etcJijigu ?? '-');
    const heit     = pick(recap?.heit ?? titleFallback?.heit ?? basisFallback?.heit, 'm');

    const hhld = (recap?.hhldCnt ?? recap?.fmlyCnt ?? recap?.hoCnt ?? titleFallback?.hhldCnt ?? '-'); // ì„¸ëŒ€ìˆ˜ ê³„ì—´
    const bldCnt = (recap?.bldCnt ?? recap?.bldgCnt ?? recap?.totBldCnt ?? '-'); // ê±´ì¶•ë¬¼ ìˆ˜ ê³„ì—´(ì—†ìœ¼ë©´ -)

    const pk = (recap?.mgmBldrgstPk || recap?.bldId || titleFallback?.mgmBldrgstPk || '-');
    const uniq = (recap?.regstrGbCd ? `${recap.regstrGbCd}` : '-'); // ê³ ìœ ë²ˆí˜¸ëŠ” API í•„ë“œê°€ í™•ì‹¤ì¹˜ ì•Šì•„ ì¼ë‹¨ '-' (ìˆìœ¼ë©´ í‘œì‹œ)

    const keyLine = `sigunguCd=${saved.sigunguCd}, bjdongCd=${saved.bjdongCd}, platGbCd=${saved.platGbCd}, bun=${saved.bun}, ji=${saved.ji}`;

    // --- â€œê±´ì¶•ë¬¼ í˜„í™©(ì„)â€ : getBrTitleInfo item ì „ì²´ ì¶œë ¥ (ì£¼/ë¶€ í¬í•¨) ---
    const titleRows = data.title.map(t=>{
      const nm = t?.bldNm || t?.dongNm || '-'; // ì£¼1/ë¶€1 ë“± ë“¤ì–´ì˜¤ëŠ” ê²½ìš°ê°€ ë§ìŒ
      const addr = t?.newPlatPlc || t?.platPlc || platPlc || '-';
      const strct = t?.strctCdNm || '-';
      const roof  = t?.roofCdNm || '-';
      const flr   = `${pick(t?.ugrndFlrCnt, '')}/${pick(t?.grndFlrCnt, '')}`.replaceAll('-', '');
      const purp  = t?.mainPurpsCdNm || '-';
      const area  = (t?.totArea !== undefined && t?.totArea !== null && t?.totArea !== '') ? String(t.totArea) : '-';
      const chgDay= t?.pmsDay || t?.useAprDay || t?.crtnDay || '-';   // ë³€ë™ì¼ í›„ë³´
      const chgRs = t?.pmsKndCdNm || t?.etcPurps || t?.rm || '-';     // ë³€ë™ì›ì¸ í›„ë³´(ì •í™•íˆëŠ” APIì— ì—†ì„ ìˆ˜ ìˆìŒ)

      // êµ¬ë¶„(ì£¼/ë¶€): ëª…ì¹­ì´ "ì£¼"ë¡œ ì‹œì‘í•˜ë©´ ì£¼, "ë¶€"ë©´ ë¶€, ì•„ë‹ˆë©´ '-'
      const g = (String(nm).startsWith('ë¶€') ? 'ë¶€' : (String(nm).startsWith('ì£¼') ? 'ì£¼' : '-'));

      return `
        <tr>
          <td class="center">${escapeHtml(g)}</td>
          <td>${escapeHtml(nm)}</td>
          <td>${escapeHtml(addr)}</td>
          <td class="center">${escapeHtml(strct)}</td>
          <td class="center">${escapeHtml(roof)}</td>
          <td class="center">${escapeHtml(flr)}</td>
          <td class="center">${escapeHtml(purp)}</td>
          <td class="right">${escapeHtml(area)}</td>
          <td class="center">${escapeHtml(chgDay)}</td>
          <td class="center">${escapeHtml(chgRs)}</td>
        </tr>
      `;
    }).join('') || `<tr><td colspan="10" class="center">-</td></tr>`;

    // --- ì „ìœ /ê³µìš©ë©´ì  í•„í„° + í•©ê³„ ---
    const pubuseFiltered = data.pubuse.filter(r=>{
      const k = pubuseKind(r);
      if(pubuseFilter === 'ALL') return true;
      if(pubuseFilter === 'PRIVATE') return k === 'PRIVATE';
      if(pubuseFilter === 'PUBLIC') return k === 'PUBLIC';
      return true;
    });
    const pubuseTot = sumNums(pubuseFiltered, 'area');
    const pubuseRows = pubuseFiltered.map(p => `
      <tr>
        <td class="center">${escapeHtml(pick(p?.exposPubuseGbCdNm || p?.exposPubuseGbCd))}</td>
        <td class="center">${escapeHtml(floorLabel(floorSortKey(p)))}</td>
        <td class="center">${escapeHtml(pick(p?.mainPurpsCdNm))}</td>
        <td class="right">${escapeHtml(pick(p?.area))}</td>
      </tr>
    `).join('') || `<tr><td colspan="4" class="center">-</td></tr>`;

    // --- ì „ìœ ë¶€(í˜¸ ì •ë ¬ë¨) ---
    const exposRows = data.expos.map(e => {
      const ho = e?.hoNm || e?.hoNo || e?.unitNm || '-';
      const ph = parseHo(ho);
      const floorGuess = ph.ok ? `${ph.floor}ì¸µ` : '-';
      return `
        <tr>
          <td class="center">${escapeHtml(pick(e?.dongNm))}</td>
          <td class="center">${escapeHtml(pick(ho))}</td>
          <td class="center">${escapeHtml(floorGuess)}</td>
          <td class="center">${escapeHtml(pick(e?.mainPurpsCdNm))}</td>
          <td class="right">${escapeHtml(pick(e?.area))}</td>
        </tr>
      `;
    }).join('') || `<tr><td colspan="5" class="center">-</td></tr>`;

    // --- ì£¼íƒê°€ê²©(ë‚ ì§œ ì •ë ¬ + ì½¤ë§ˆ) ---
    const hsprcRows = data.hsprc.map(h => {
      const day = h?.stdDay || h?.baseDay || h?.applcDay || '-';
      const priceRaw = h?.hsprc || h?.housePc || h?.price || '-';
      const price = (priceRaw === '-' ? '-' : formatNumberComma(priceRaw));
      const area = pickAreaField(h);
      const rm = h?.rm || h?.etc || '-';
      return `
        <tr>
          <td class="center">${escapeHtml(pick(day))}</td>
          <td class="center">${escapeHtml(pick(area))}</td>
          <td class="right">${escapeHtml(price)}</td>
          <td>${escapeHtml(pick(rm))}</td>
        </tr>
      `;
    }).join('') || `<tr><td colspan="4" class="center">-</td></tr>`;

    // --- ì§€ì—­ì§€êµ¬êµ¬ì—­ ---
    const jijiguRows = data.jijigu.map(j => `
      <tr>
        <td>${escapeHtml(pick(j?.jijiguNm || j?.etcJijigu || j?.etcJijiguNm))}</td>
        <td>${escapeHtml(pick(j?.jijiguCdNm || j?.jijiguGbCdNm || j?.jijiguCd))}</td>
        <td>${escapeHtml(pick(j?.regstrGbCdNm || j?.etc))}</td>
      </tr>
    `).join('') || `<tr><td colspan="3" class="center">-</td></tr>`;

    // --- ì¸µë³„ê°œìš” ---
    const floorRows = data.flr.map(f => `
      <tr>
        <td class="center">${escapeHtml(floorLabel(floorSortKey(f)))}</td>
        <td class="center">${escapeHtml(pick(f?.mainPurpsCdNm))}</td>
        <td class="right">${escapeHtml(pick(f?.area))}</td>
      </tr>
    `).join('') || `<tr><td colspan="3" class="center">-</td></tr>`;

    // --- ë¶€ì†ì§€ë²ˆ ---
    const atchRows = data.atch.map(a => `
      <tr>
        <td>${escapeHtml(pick(a?.platPlc))}</td>
        <td class="center">${escapeHtml(pick(a?.platGbCdNm || a?.platGbCd))}</td>
        <td class="center">${escapeHtml(pick(a?.bun))}</td>
        <td class="center">${escapeHtml(pick(a?.ji))}</td>
      </tr>
    `).join('') || `<tr><td colspan="4" class="center">-</td></tr>`;

    // --- ì˜¤ìˆ˜ì •í™” ---
    const wclfRows = data.wclf.map(w => `
      <tr>
        <td class="center">${escapeHtml(pick(w?.wclfGbCdNm || w?.wclfGbCd))}</td>
        <td class="center">${escapeHtml(pick(w?.wclfNm || w?.wclfKndNm))}</td>
        <td class="center">${escapeHtml(pick(w?.wclfCap || w?.wclfCapa))}</td>
        <td class="center">${escapeHtml(pick(w?.wclfCnt))}</td>
        <td>${escapeHtml(pick(w?.etc || w?.rm))}</td>
      </tr>
    `).join('') || `<tr><td colspan="5" class="center">-</td></tr>`;

    document.getElementById('result-container').innerHTML = `
      <div class="form-a4">
        <div class="top-meta">
          <div>â€» ê±´ì¶•ë¬¼ëŒ€ì¥ì˜ ê¸°ì¬ ë° ê´€ë¦¬ ë“±ì— ê´€í•œ ê·œì¹™ [ë³„ì§€ ì œ8í˜¸ì„œì‹] (ì´ê´„í‘œì œë¶€ ê¸°ì¤€ ì¶œë ¥)</div>
          <div class="right">(Key) ${escapeHtml(keyLine)}</div>
        </div>

        <div class="form-title">ê±´ì¶•ë¬¼ëŒ€ì¥ ì´ê´„í‘œì œë¶€(ê°‘)</div>

        <!-- ìƒë‹¨ ìš”ì•½(ì´ê´„í‘œì œë¶€(ê°‘) ê¸°ì¤€) -->
        <table class="form">
          <colgroup>
            <col style="width:12%"><col style="width:18%">
            <col style="width:12%"><col style="width:18%">
            <col style="width:12%"><col style="width:28%">
          </colgroup>
          <tr>
            <td class="lbl center">ê±´ë¬¼ID</td>
            <td>${escapeHtml(pick(pk))}</td>
            <td class="lbl center">ê³ ìœ ë²ˆí˜¸</td>
            <td>${escapeHtml(pick(uniq))}</td>
            <td class="lbl center">ê±´ì¶•ë¬¼ëª…ì¹­</td>
            <td>${escapeHtml(pick(bldName))}</td>
          </tr>
          <tr>
            <td class="lbl center">ëŒ€ì§€ìœ„ì¹˜</td>
            <td colspan="5">${escapeHtml(pick(platPlc))}</td>
          </tr>
          <tr>
            <td class="lbl center">ëŒ€ì§€ë©´ì </td>
            <td>${escapeHtml(platArea)}</td>
            <td class="lbl center">ì—°ë©´ì </td>
            <td>${escapeHtml(totArea)}</td>
            <td class="lbl center">ì§€ì—­</td>
            <td>${escapeHtml(zone)}</td>
          </tr>
          <tr>
            <td class="lbl center">ê±´ì¶•ë©´ì </td>
            <td>${escapeHtml(archArea)}</td>
            <td class="lbl center">ìš©ì ë¥  ì‚°ì •ìš© ì—°ë©´ì </td>
            <td>${escapeHtml(vlRatEstmTotArea)}</td>
            <td class="lbl center">ì£¼ìš©ë„</td>
            <td>${escapeHtml(mainPurp)}</td>
          </tr>
          <tr>
            <td class="lbl center">ê±´íìœ¨</td>
            <td>${escapeHtml(bcRat)}</td>
            <td class="lbl center">ìš©ì ë¥ </td>
            <td>${escapeHtml(vlRat)}</td>
            <td class="lbl center">ë†’ì´</td>
            <td>${escapeHtml(heit)}</td>
          </tr>
          <tr>
            <td class="lbl center">ê±´ì¶•ë¬¼ ìˆ˜</td>
            <td>${escapeHtml(pick(bldCnt))}</td>
            <td class="lbl center">í˜¸ìˆ˜/ê°€êµ¬ìˆ˜/ì„¸ëŒ€ìˆ˜</td>
            <td>${escapeHtml(pick(hhld))}</td>
            <td class="lbl center">ì‚¬ìš©ìŠ¹ì¸ì¼</td>
            <td>${escapeHtml(useApr)}</td>
          </tr>
          <tr>
            <td class="lbl center">ì†Œìœ ì í˜„í™©</td>
            <td colspan="5">ë¯¸ì œê³µ(-) (ë³¸ OpenAPI ëª©ë¡ì— ì†Œìœ ì ì¡°íšŒ í•­ëª© ì—†ìŒ)</td>
          </tr>
        </table>

        <!-- ì§€ì—­ì§€êµ¬êµ¬ì—­ -->
        <div class="section-head"><span>ì§€ì—­Â·ì§€êµ¬Â·êµ¬ì—­ (getBrJijiguInfo)</span></div>
        <table class="form" data-collapsible="1">
          <colgroup>
            <col style="width:55%"><col style="width:25%"><col style="width:20%">
          </colgroup>
          <tr>
            <th class="center">ëª…ì¹­</th>
            <th class="center">êµ¬ë¶„/ì½”ë“œ</th>
            <th class="center">ë¹„ê³ </th>
          </tr>
          ${jijiguRows}
        </table>

        <!-- ê±´ì¶•ë¬¼ í˜„í™©(ì„): í‘œì œë¶€ item ì „ì²´ ë‚˜ì—´ -->
        <div class="section-head">
          <span>ê±´ì¶•ë¬¼ í˜„í™© (ì´ê´„í‘œì œë¶€(ì„) ìŠ¤íƒ€ì¼) â€” getBrTitleInfo ì „ì²´</span>
          <span class="small muted">â€» ì£¼/ë¶€ í¬í•¨, bldNm(ì£¼1/ë¶€1 ë“±) ê¸°ì¤€ ì •ë ¬</span>
        </div>
        <table class="form">
          <colgroup>
            <col style="width:6%">
            <col style="width:14%">
            <col style="width:19%">
            <col style="width:12%">
            <col style="width:10%">
            <col style="width:7%">
            <col style="width:12%">
            <col style="width:10%">
            <col style="width:10%">
            <col style="width:10%">
          </colgroup>
          <tr>
            <th class="center">êµ¬ë¶„</th>
            <th class="center">ê±´ì¶•ë¬¼ëª…ì¹­(ë²ˆí˜¸)</th>
            <th class="center">ë„ë¡œëª…ì£¼ì†Œ/ëŒ€ì§€ìœ„ì¹˜</th>
            <th class="center">ê±´ì¶•ë¬¼ ì£¼êµ¬ì¡°</th>
            <th class="center">ê±´ì¶•ë¬¼ ì§€ë¶•</th>
            <th class="center">ì¸µìˆ˜</th>
            <th class="center">ìš©ë„</th>
            <th class="center">ì—°ë©´ì (ã¡)</th>
            <th class="center">ë³€ë™ì¼</th>
            <th class="center">ë³€ë™ì›ì¸</th>
          </tr>
          ${titleRows}
        </table>

        <!-- ì°¸ê³ ìš©: ì¸µë³„ê°œìš”/ë¶€ì†ì§€ë²ˆ/ì „ìœ ê³µìš©/ì „ìœ ë¶€/ì˜¤ìˆ˜ì •í™”/ì£¼íƒê°€ê²© -->
        <div class="section-head"><span>ì¸µë³„ê°œìš” (getBrFlrOulnInfo)</span><span class="small muted">ì •ë ¬: ì§€í•˜ â†’ ì§€ìƒ</span></div>
        <table class="form" data-collapsible="1">
          <colgroup>
            <col style="width:26%"><col style="width:52%"><col style="width:22%">
          </colgroup>
          <tr>
            <th class="center">ì¸µ</th>
            <th class="center">ìš©ë„</th>
            <th class="center">ë©´ì (ã¡)</th>
          </tr>
          ${floorRows}
        </table>

        <div class="section-head"><span>ë¶€ì†ì§€ë²ˆ (getBrAtchJibunInfo)</span></div>
        <table class="form" data-collapsible="1">
          <colgroup>
            <col style="width:52%"><col style="width:16%"><col style="width:16%"><col style="width:16%">
          </colgroup>
          <tr>
            <th class="center">ì£¼ì†Œ</th>
            <th class="center">ëŒ€ì§€êµ¬ë¶„</th>
            <th class="center">ë²ˆ</th>
            <th class="center">ì§€</th>
          </tr>
          ${atchRows}
        </table>

        <div class="section-head">
          <span>ì „ìœ Â·ê³µìš©ë©´ì  (getBrExposPubuseAreaInfo) â€” í•©ê³„: ${escapeHtml(pick(pubuseTot.toFixed(2)))}ã¡</span>
          <span class="filter-box">
            <button class="fbtn ${pubuseFilter==='ALL'?'active':''}" data-pubuse-filter="ALL" onclick="setPubuseFilter('ALL')">ì „ì²´</button>
            <button class="fbtn ${pubuseFilter==='PRIVATE'?'active':''}" data-pubuse-filter="PRIVATE" onclick="setPubuseFilter('PRIVATE')">ì „ìœ </button>
            <button class="fbtn ${pubuseFilter==='PUBLIC'?'active':''}" data-pubuse-filter="PUBLIC" onclick="setPubuseFilter('PUBLIC')">ê³µìš©</button>
          </span>
        </div>
        <table class="form" data-collapsible="1">
          <colgroup>
            <col style="width:18%"><col style="width:18%"><col style="width:40%"><col style="width:24%">
          </colgroup>
          <tr>
            <th class="center">êµ¬ë¶„</th>
            <th class="center">ì¸µ</th>
            <th class="center">ìš©ë„</th>
            <th class="center">ë©´ì (ã¡)</th>
          </tr>
          ${pubuseRows}
        </table>

        <div class="section-head"><span>ì „ìœ ë¶€ (getBrExposInfo)</span><span class="small muted">ì •ë ¬: 107â†’1ì¸µ, 1002â†’10ì¸µ</span></div>
        <table class="form" data-collapsible="1">
          <colgroup>
            <col style="width:12%"><col style="width:16%"><col style="width:12%"><col style="width:38%"><col style="width:22%">
          </colgroup>
          <tr>
            <th class="center">ë™</th>
            <th class="center">í˜¸</th>
            <th class="center">ì¸µ(ì¶”ì •)</th>
            <th class="center">ìš©ë„</th>
            <th class="center">ë©´ì (ã¡)</th>
          </tr>
          ${exposRows}
        </table>

        <div class="section-head"><span>ì˜¤ìˆ˜ì •í™”ì‹œì„¤ (getBrWclfInfo)</span></div>
        <table class="form" data-collapsible="1">
          <colgroup>
            <col style="width:16%"><col style="width:26%"><col style="width:16%"><col style="width:12%"><col style="width:30%">
          </colgroup>
          <tr>
            <th class="center">êµ¬ë¶„</th>
            <th class="center">ëª…ì¹­/ì¢…ë¥˜</th>
            <th class="center">ìš©ëŸ‰</th>
            <th class="center">ìˆ˜ëŸ‰</th>
            <th class="center">ë¹„ê³ </th>
          </tr>
          ${wclfRows}
        </table>

        <div class="section-head"><span>ì£¼íƒê°€ê²© (getBrHsprcInfo)</span><span class="small muted">ì •ë ¬: ê¸°ì¤€ì¼ ì˜¤ë¦„ì°¨ìˆœ / ê°€ê²© ì½¤ë§ˆ</span></div>
        <table class="form" data-collapsible="1">
          <colgroup>
            <col style="width:22%"><col style="width:18%"><col style="width:30%"><col style="width:30%">
          </colgroup>
          <tr>
            <th class="center">ê¸°ì¤€ì¼</th>
            <th class="center">ë©´ì (ìˆìœ¼ë©´)</th>
            <th class="center">ê°€ê²©</th>
            <th class="center">ë¹„ê³ </th>
          </tr>
          ${hsprcRows}
        </table>

        <table class="form" style="margin-top:8px;">
          <tr style="height:38px;">
            <td class="small">
              ì´ ë“±(ì´ˆ)ë³¸ì€ ê±´ì¶•ë¬¼ëŒ€ì¥ì˜ ì›ë³¸ë‚´ìš©ê³¼ í‹€ë¦¼ì—†ìŒì„ ì¦ëª…í•©ë‹ˆë‹¤.
              <span style="float:right;">ë°œê¸‰ì¼: ${escapeHtml(new Date().toISOString().slice(0,10))}</span>
            </td>
          </tr>
          <tr style="height:38px;">
            <td class="small">
              ë‹´ë‹¹ì: ________  ì „ í™”: ________
              <span style="float:right;">ì‹œì¥Â·êµ°ìˆ˜Â·êµ¬ì²­ì¥ (ì¸)</span>
            </td>
          </tr>
        </table>
      </div>
    `;

    window.scrollTo({top:0, behavior:'smooth'});
    if(collapsed){
      document.querySelectorAll('[data-collapsible="1"]').forEach(el=> el.style.display='none');
    }
  }
</script>
</body>
</html>
